---
title: "Week 8 - SQL Injection Point Analysis and Mitigation Techniques"
date: 2025-06-03
categories: [study]
layout: single
author_profile: true
sidebar:
  nav: "main"
read_time: true
toc: true
toc_label: "On this page"
toc_sticky: true
---

오늘 주제는 SQL Injection이 일어나는 point를 찾는데에 좀 더 집중해보자

우선 다른 post에도 언급했지만 SQL Injection은 크게 3가지로 나눌 수 있다.
첫째 Union SQL Injection
둘째 Error Based SQL Injection
셋째 Blind SQL Injection
위 3가지로 나뉜다.

위 3가지를 실행하는 가장 큰 목적은 서버의 DB로부터 우리가 원하는 데이터를 탈취하기위해 sql의 SELECT문을 실행하는 것이라고 볼 수 있다.
이 때 Blind SQL Injection은 SQL Injection이 일어날 수 있는 곳에서는 언제든지 사용이 가능하지만 다소 느리고 번거로울 수 있기에 각 상황에 맞게 효율적인 방법을 택하는것이 중요하다.

## SQL Injection Point찾기

인젝션 포인트를 찾기위해선 사용자와 서버안의 DB가 서로 데이터를 주고받는 즉 상호작용을 하는 곳을 발견해야한다.
웹 페이지는 고정되고 정적인 데이터 예를들어 사이트 제목과같이 html에서 넣은 값들이 있을 수 있다. 또는 DB에서 가져오는 값이 있을 수 있다.

게시판 / 로그인 / 회원가입 등등 SQL은 inset, select 다양한 쿼리가 존재함 무지성으로 항등식을 삽입하는것보다 sql 쿼리를 먼저 생각해보고 넣어야한다.
SQLi 페이로드를 삽입할 때 항상 명분을 가지고 있어야 합니다. 내가 어떠한 파라미터를 넣었을 때 파라미터가 어디에서 어떻게 작동할 것이고, 쿼리가 실행되고 어떠한 값이 출력될 것인가를 생각하고 유추하여야 합니다.
SQLi 페이로드를 만들 때 주석 사용은 지양해야 합니다. 규모가 큰 웹 서버가 타겟인 경우 주석 사용으로 뒤에 문장이 무시될 때 쿼리가 정상적으로 실행되지 않는 문제가 발생할 수 있습니다.

몇가지 Case를 통해 어떻게 Injection Point를 찾는지 알아보자


## 1. Cookie 기반 SQL Injection

![image](https://github.com/user-attachments/assets/aadb8b00-e263-4808-bc51-01ffe6129bf5)
Cookie = jimin일때 볼 수 있는 마이페이지 화면 

이 때 쿠키에 있는 변수 user에 들어갈 값을 변화시켜 참과 거짓을 구분지을 수 있는지 확인해보자
user에 어떤 값을 넣어보기전에 우선 sql 쿼리가 어떤 식으로 구성이되어있을지 원리를 먼저 예상해보자

보통의 웹 페이지 흐름에서 변수와 sql쿼리는 아래와 같다고 볼 수 있다.

```
$username = $_COOKIE['user'];
$result = mysqli_query($conn, "SELECT * FROM 테이블이름 WHERE id = '$username'");
```
이때 우리가 cookie = jimin이기때문에 서버는 
$result = mysqli_query($conn, "SELECT * FROM 테이블이름 WHERE id = 'jimin'");
라고 result변수를 정의할것이고 이때 result의 값이 0보다 큰지 작은지 즉 row가 존재하는지 존재하지않는지를 비교해서 웹페이지의 변화를 줄 것이라고 생각할 수 있다.

결과적으로 jimin' and '1'='1을 삽입해도 SELECT * FROM 테이블이름 WHERE id = 'jimin' and '1'='1'로 문법적 오류가 없고 jimin을 삽입했을때와 같은 참일것이라고 예측 가능하고 user에 jimin을 넣었을때와 같은 웹 페이지를 주고 'jimin' and '1'='2를 넣었을때 다른 페이지를 출력한다면 참 / 거짓으로 나눌 수 있다고 판단이 가능하다. 따라서 jimin' and '1'='1를 넣어보는 근거가 있다.

![image](https://github.com/user-attachments/assets/20c0386b-86c5-46bd-b690-1c49f91768f1)
jimin' and '1'='1을 삽입했을때는 jimin을 삽입했을때와 결과가 같다.

![image](https://github.com/user-attachments/assets/0336d114-4a9c-4cb0-b030-61853b197600)
jimin' and '1'='2을 삽입하면 "Nothing Here..."라는 문구가 사라졌으므로 참 거짓이 존재한다

따라서 참과 거짓 조건에 따라 달라지는 응답조건을 확인할 수 있고

이에 sql질의에 따라 조건이 달라진다는 것을 확인할 수 있어, 

취약점이 존재한다는 것을 확인할 수 있다.


## 2. 컬럼명 기반 SQL Injection

실습 목표 요약
사용자 입력값이 SQL 쿼리 안에서 '컬럼명'으로 사용되는 경우,
이를 악용해 참/거짓 조건을 넣어 SQL Injection이 가능한지 테스트하는 실습.

배경 상황
게시판에서 특정 컬럼을 기준으로 검색하거나 정렬하는 기능이 있다.
이때 URL 또는 POST 파라미터에 포함된 값이 SQL 쿼리 내 컬럼명 자리에 들어간다.
![image](https://github.com/user-attachments/assets/766b3eb2-6d26-4f6f-8b16-bbff9523d951)

이로써 아까 1번과같이 sql쿼리를 다시한번 예측해보자
우선 게시판은 게시글을 사용자가에게 보여주어야함으로 select함수를 사용할것이다 그리고 우리가 입력한 파라미터 board_result=test 가 쿼리안에 어떻게 들어갈지 상상해보자 
게시글은 우리가 입력한 파라미터값에 like를 씌워주어 우리가 입력한 값이 있는 게시글만 보여주는 쿼리를 보통이라면 만들었을것이다 즉 

```
SELECT * FROM 테이블 이름 WHERE [option_val] LIKE '%[board_result]%';
```
위와 같은 구조라고 상상할 수 있다.
추가로 우리가 선택한 작성자, 제목, 내용은 option_val	컬럼명으로 사용됨 (ex: title, username 등)

의심이 되는 곳을 찾았으니 몇가지 값을 넣어 정말 SQL Injectio이 존재하는지 가려보도록하자

컬럼 자리에 논리 연산을 포함한 SQL 조작을 삽입해서
참/거짓 조건에 따라 응답이 달라지는지 확인함으로써 취약점을 판단한다




![image](https://github.com/user-attachments/assets/274a1ca4-864c-4068-82d3-0da58cec341b)
option_val에 ('1'='1') and test를 삽입했다 예상할 수 있는 sql 쿼리는 
```
SELECT * FROM 테이블 이름 WHERE ('1'='1') and test LIKE '%[board_result]%';
```
이때 게시판이 정상적으로 정렬되고있으므로 우리가 넣은 값이 sql 쿼리에 먹히고있다고 생각이 가능하다 이제 거짓인 경우를 시도하여 참 거짓을 구별해보자

![image](https://github.com/user-attachments/assets/022f7182-861d-4eee-8400-67b6e2885893)
예상대로 option_val에 ('1'='2') and test를 넣었더니 거짓이되어 아무런 게시글도 출력이 되지않는다.


## 3. ORDER BY 절 SQL Injection





